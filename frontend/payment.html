<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Payment - Confirm Booking</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { font-family: 'Segoe UI', Roboto, sans-serif; background: #f5f6fa; color: #333; }
    .navbar { background: linear-gradient(90deg, #0057b8, #00aaff); box-shadow: 0 3px 8px rgba(0,0,0,0.15); }
    .container { max-width: 780px; margin-top: 100px; }
    .card { border: none; box-shadow: 0 8px 24px rgba(0,0,0,0.08); border-radius: 14px; }
    .card-header { background: #fff; border-bottom: 1px solid #eee; }
    .form-control { border-radius: 10px; padding: 12px; }
    .btn-primary { background: #0057b8; border: none; border-radius: 10px; padding: 12px 18px; }
    .btn-primary:disabled { opacity: .8; }
    .summary { background: #fff; border: 1px solid #eee; border-radius: 12px; padding: 16px; }
    .success-check { width: 60px; height: 60px; border-radius: 50%; background: #e8f7ef; color: #20a164; display: flex; align-items: center; justify-content: center; font-size: 30px; margin: 0 auto 10px; }
  </style>
</head>
<body>
  <div id="navbar-host"></div>

  <div class="container">
    <div class="row g-4">
      <div class="col-lg-7">
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Payment Details</h5>
            <span class="text-muted" id="bookingRef"></span>
          </div>
          <div class="card-body">
            <form id="paymentForm">
              <ul class="nav nav-pills mb-3" id="payMethodTabs">
                <li class="nav-item"><button type="button" class="nav-link active" data-method="card">Card</button></li>
                <li class="nav-item"><button type="button" class="nav-link" data-method="upi">UPI</button></li>
              </ul>

              <div id="cardSection">
                <div class="mb-3">
                  <label class="form-label">Cardholder Name</label>
                  <input type="text" class="form-control" id="cardName" placeholder="John Doe">
                </div>
                <div class="mb-3">
                  <label class="form-label">Card Number</label>
                  <input type="text" inputmode="numeric" maxlength="19" class="form-control" id="cardNumber" placeholder="1234 5678 9012 3456">
                </div>
                <div class="row">
                  <div class="col-6 mb-3">
                    <label class="form-label">Expiry (MM/YY)</label>
                    <input type="text" inputmode="numeric" maxlength="5" class="form-control" id="cardExpiry" placeholder="MM/YY">
                  </div>
                  <div class="col-6 mb-3">
                    <label class="form-label">CVV</label>
                    <input type="password" inputmode="numeric" maxlength="4" class="form-control" id="cardCvv" placeholder="***">
                  </div>
                </div>
              </div>

              <div id="upiSection" style="display:none;">
                <div class="mb-3">
                  <label class="form-label">UPI ID</label>
                  <input type="text" class="form-control" id="upiId" placeholder="example@upi">
                </div>
                <div class="form-text mb-3">UPI will open in Razorpay. Ensure your UPI app is installed.</div>
              </div>

              <button type="submit" id="payBtn" class="btn btn-primary w-100">Pay Now</button>
              <div id="payNote" class="form-text mt-2">This is a demo payment. No real charge will be made.</div>
            </form>

            <div id="processing" class="text-center mt-4" style="display:none;">
              <div class="spinner-border text-primary" role="status"></div>
              <p class="mt-2">Processing payment, please wait...</p>
            </div>

            <div id="success" class="text-center mt-4" style="display:none;">
              <div class="success-check">✓</div>
              <h5>Payment Successful</h5>
              <p class="text-muted">Your booking has been confirmed.</p>
              <a id="viewBookingBtn" href="/dashboard.html" class="btn btn-outline-primary mt-2">Back to Dashboard</a>
            </div>
          </div>
        </div>
      </div>
      <div class="col-lg-5">
        <div class="summary">
          <h6>Booking Summary</h6>
          <hr>
          <div class="d-flex justify-content-between">
            <span>Destination</span>
            <strong id="sumDestination">-</strong>
          </div>
          <div class="d-flex justify-content-between mt-2">
            <span>Date</span>
            <strong id="sumDate">-</strong>
          </div>
          <div class="d-flex justify-content-between mt-2">
            <span>Guests</span>
            <strong id="sumGuests">-</strong>
          </div>
          <div class="d-flex justify-content-between mt-3">
            <span class="text-muted">Subtotal</span>
            <span class="text-muted" id="sumSubtotal">₹0</span>
          </div>
          <div class="d-flex justify-content-between">
            <span class="text-muted">Taxes & Fees</span>
            <span class="text-muted" id="sumFees">₹0</span>
          </div>
          <hr>
          <div class="d-flex justify-content-between">
            <span>Total</span>
            <strong id="sumTotal">₹0</strong>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="/js/auth.js"></script>
  <script src="/js/navbar.js"></script>
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  <script>
    // Read basic booking info from query params: ?dest=...&date=...&guests=...&total=...
    function getParams() {
      const p = new URLSearchParams(window.location.search);
      return {
        dest: p.get('dest') || 'Selected Destination',
        date: p.get('date') || new Date().toLocaleDateString(),
        guests: p.get('guests') || '1',
        total: Number(p.get('total')) || 4999,
        ref: p.get('ref') || 'BK' + Math.floor(Math.random()*1e6)
      };
    }

    function formatINR(n){
      try { return new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR' }).format(n); } catch { return '₹' + n; }
    }

    const params = getParams();
    const demoMode = new URLSearchParams(window.location.search).get('demo') === '1';
    document.getElementById('bookingRef').textContent = '#' + params.ref;
    document.getElementById('sumDestination').textContent = params.dest;
    document.getElementById('sumDate').textContent = params.date;
    document.getElementById('sumGuests').textContent = params.guests;
    const fees = Math.round(params.total * 0.18);
    document.getElementById('sumSubtotal').textContent = formatINR(params.total);
    document.getElementById('sumFees').textContent = formatINR(fees);
    const totalPay = params.total + fees;
    document.getElementById('sumTotal').textContent = formatINR(totalPay);
    const payBtnEl = document.getElementById('payBtn');
    if (payBtnEl) payBtnEl.textContent = `Pay Now (${formatINR(totalPay)})`;

    // Simple input formatting (visual only)
    const cardNumber = document.getElementById('cardNumber');
    cardNumber.addEventListener('input', () => {
      let v = cardNumber.value.replace(/\D/g, '').slice(0,16);
      cardNumber.value = v.replace(/(.{4})/g, '$1 ').trim();
    });
    const cardExpiry = document.getElementById('cardExpiry');
    cardExpiry.addEventListener('input', () => {
      let v = cardExpiry.value.replace(/\D/g, '').slice(0,4);
      if (v.length >= 3) v = v.slice(0,2) + '/' + v.slice(2);
      cardExpiry.value = v;
    });

    // Toggle Card vs UPI sections
    const cardSection = document.getElementById('cardSection');
    const upiSection = document.getElementById('upiSection');
    document.querySelectorAll('#payMethodTabs .nav-link').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('#payMethodTabs .nav-link').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        const method = btn.getAttribute('data-method');
        if (method === 'upi') { cardSection.style.display = 'none'; upiSection.style.display = ''; }
        else { cardSection.style.display = ''; upiSection.style.display = 'none'; }
      });
    });

    document.getElementById('paymentForm').addEventListener('submit', async function(e){
      e.preventDefault();
      const btn = document.getElementById('payBtn');
      btn.disabled = true;
      // Basic client-side validation
      const activeMethod = document.querySelector('#payMethodTabs .nav-link.active')?.getAttribute('data-method');
      if (activeMethod === 'card') {
        const name = document.getElementById('cardName').value.trim();
        const number = document.getElementById('cardNumber').value.replace(/\s+/g,'');
        const expiry = document.getElementById('cardExpiry').value.trim();
        const cvv = document.getElementById('cardCvv').value.trim();
        const numberOk = /^\d{16}$/.test(number);
        const expiryOk = /^(0[1-9]|1[0-2])\/(\d{2})$/.test(expiry);
        const cvvOk = /^\d{3,4}$/.test(cvv);
        if (!name || !numberOk || !expiryOk || !cvvOk) {
          alert('Please enter valid card details (name, 16-digit number, MM/YY, CVV).');
          btn.disabled = false;
          return;
        }
      } else if (activeMethod === 'upi') {
        const upi = document.getElementById('upiId').value.trim();
        const upiOk = /^[\w.\-]{2,}@[\w]{2,}$/.test(upi);
        if (!upiOk) {
          alert('Please enter a valid UPI ID (e.g., example@upi).');
          btn.disabled = false;
          return;
        }
      }

      // Validate total > 0
      if (!Number.isFinite(totalPay) || totalPay <= 0) {
        alert('Invalid total amount.');
        btn.disabled = false;
        return;
      }

      // Demo mode: simulate success without Razorpay
      if (demoMode) {
        document.getElementById('processing').style.display = '';
        setTimeout(() => {
          document.getElementById('processing').style.display = 'none';
          document.getElementById('paymentForm').style.display = 'none';
          document.getElementById('success').style.display = '';
          try { document.getElementById('success').scrollIntoView({ behavior: 'smooth' }); } catch {}
          btn.disabled = false;
        }, 1200);
        return;
      }

      // Create order via backend
      try {
        const res = await fetch('/api/pay/razorpay/order', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ amountPaise: Math.round(totalPay * 100), currency: 'INR', receipt: params.ref })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.message || 'Unable to create order');

        const order = data.order;
        const keyId = data.keyId;
        if (!window.Razorpay || !order || !order.id || !keyId) throw new Error('Razorpay not available');

        const methodSelected = document.querySelector('#payMethodTabs .nav-link.active')?.getAttribute('data-method');
        const options = {
          key: keyId,
          amount: order.amount,
          currency: order.currency,
          name: 'TrioTrails',
          description: `Booking ${params.dest}`,
          order_id: order.id,
          handler: async function (resp) {
            // Show processing while verifying
            document.getElementById('processing').style.display = '';
            try {
              const verifyRes = await fetch('/api/pay/razorpay/verify', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  razorpay_order_id: resp.razorpay_order_id,
                  razorpay_payment_id: resp.razorpay_payment_id,
                  razorpay_signature: resp.razorpay_signature
                })
              });
              const verifyData = await verifyRes.json();
              if (!verifyRes.ok || !verifyData.valid) throw new Error('Verification failed');
              // Hide form and show success
              document.getElementById('paymentForm').style.display = 'none';
              document.getElementById('processing').style.display = 'none';
              document.getElementById('success').style.display = '';
              try { document.getElementById('success').scrollIntoView({ behavior: 'smooth' }); } catch {}
            } catch (_) {
              document.getElementById('processing').style.display = 'none';
              alert('Payment verification failed.');
            } finally {
              btn.disabled = false;
            }
          },
          prefill: {
            name: document.getElementById('cardName').value || 'Guest',
            // Razorpay may ignore vpa prefill in some contexts; included as hint
            vpa: (document.getElementById('upiId').value || undefined)
          },
          notes: { booking_ref: params.ref },
          theme: { color: '#0057b8' },
          config: {
            display: {
              sequence: (methodSelected === 'upi')
                ? ['upi','card','netbanking','wallet']
                : ['card','upi','netbanking','wallet'],
              preferences: { show_default_blocks: true }
            }
          },
          method: methodSelected === 'upi' ? { upi: true } : { card: true }
        };

        const rzp = new Razorpay(options);
        rzp.on('payment.failed', function () {
          alert('Payment failed or cancelled.');
          btn.disabled = false;
        });
        rzp.open();
      } catch (err) {
        // If payment initiation fails, simulate a completed payment flow
        document.getElementById('processing').style.display = '';
        setTimeout(() => {
          document.getElementById('processing').style.display = 'none';
          document.getElementById('paymentForm').style.display = 'none';
          document.getElementById('success').style.display = '';
          try { document.getElementById('success').scrollIntoView({ behavior: 'smooth' }); } catch {}
          btn.disabled = false;
        }, 1200);
      }
    });
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>


